<%*
// 获取用户输入的日程信息
const scheduleInput = await tp.system.prompt("请输入日程信息（包含时间和任务描述）：");

if (!scheduleInput) {
    new Notice("请输入日程信息");
    return;
}

// 获取当前日期
const today = tp.date.now("YYYY-MM-DD");
const tomorrow = tp.date.now("YYYY-MM-DD", 1);
const now = new Date();

// 识别日期和时间的函数
function parseDateTime(input) {
    const dateMatch = input.match(/(\d{4}-\d{2}-\d{2})/);
    const timeMatch = input.match(/(\d{1,2}):(\d{2})/);
    
    let targetDate = today;
    let timeStr = "";
    
    // 识别日期关键词
    if (input.includes("明天") || input.includes("tomorrow")) {
        targetDate = tomorrow;
    } else if (input.includes("后天")) {
        targetDate = tp.date.now("YYYY-MM-DD", 2);
    } else if (input.includes("下周")) {
        targetDate = tp.date.now("YYYY-MM-DD", 7);
    } else if (dateMatch) {
        targetDate = dateMatch[1];
    }
    
    // 识别时间
    if (timeMatch) {
        timeStr = ` ${timeMatch[1]}:${timeMatch[2]}`;
    }
    
    return { targetDate, timeStr };
}

// 判断任务类型
function getTaskType(input) {
    if (input.includes("会议") || input.includes("meeting") || input.includes("讨论") || input.includes("review")) {
        return "meeting";
    } else if (input.includes("完成") || input.includes("做") || input.includes("写") || input.includes("开发")) {
        return "task";
    } else {
        return "reminder";
    }
}

// 解析日程信息
const { targetDate, timeStr } = parseDateTime(scheduleInput);
const taskType = getTaskType(scheduleInput);

// 清理输入描述（移除时间关键词）
let cleanDescription = scheduleInput
    .replace(/(\d{4}-\d{2}-\d{2})/, "")
    .replace(/(\d{1,2}):(\d{2})/, "")
    .replace(/今天|明天|后天|下周|today|tomorrow|next week/gi, "")
    .replace(/会议|meeting|讨论|review/gi, "")
    .trim();

// 根据任务类型处理
if (taskType === "meeting") {
    // 创建会议笔记
    const meetingTitle = cleanDescription || "会议";
    const meetingFileName = `${targetDate} - ${meetingTitle}`;
    const meetingPath = `40 - OPERATIONS/Meetings/${meetingFileName}.md`;
    
    // 检查是否已存在
    const meetingFile = app.vault.getAbstractFileByPath(meetingPath);
    if (!meetingFile) {
        // 创建会议笔记
        const meetingContent = `---
tags: meeting
date: ${targetDate}
time: "${timeStr.trim()}"
participants: 
---

# ${meetingTitle}

## 会议目标

## 讨论要点

## 关键决策

## 行动项
- [ ] 
- [ ] 

## 相关链接
- [[${today}]]
`;
        await tp.file.create_new(meetingContent, meetingPath);
        new Notice(`已创建会议笔记：${meetingTitle}`);
    }
    
    // 如果是今天的会议，添加到当前笔记
    if (targetDate === today) {
        const meetingLink = `[[${meetingFileName}]]${timeStr}`;
        const currentContent = tp.file.content;
        
        // 查找今日关键日程部分并添加链接
        const scheduleSection = currentContent.match(/🗓️ 今日关键日程 \(Scheduled Events\):\*[\s\S]*?(?=\n---|\n###)/);
        if (scheduleSection) {
            const updatedContent = currentContent.replace(
                scheduleSection[0],
                scheduleSection[0] + `\n- ${meetingLink}`
            );
            await tp.file.update(updatedContent);
        }
    }
} else {
    // 创建任务
    const priority = scheduleInput.includes("紧急") || scheduleInput.includes("重要") ? "high" : 
                   scheduleInput.includes("中等") ? "medium" : "low";
    
    const taskFormat = `- [ ] ${cleanDescription}${timeStr} 📅 ${targetDate} priority:: ${priority}`;
    
    // 如果是今天的任务，添加到当前笔记
    if (targetDate === today) {
        const currentContent = tp.file.content;
        
        // 查找今日待办任务部分并添加任务
        const taskSection = currentContent.match(/📋 今日待办任务 \(Today's Tasks\):\*[\s\S]*?(?=\n---|\n###)/);
        if (taskSection) {
            const updatedContent = currentContent.replace(
                taskSection[0],
                taskSection[0] + `\n${taskFormat}`
            );
            await tp.file.update(updatedContent);
        }
    } else {
        // 创建或更新未来日期的每日笔记
        const futureNotePath = `10 - COCKPIT/Daily/${targetDate}.md`;
        const futureFile = app.vault.getAbstractFileByPath(futureNotePath);
        
        if (!futureFile) {
            // 创建新的每日笔记
            const dailyTemplate = `---
tags: daily
date: ${targetDate}
week: "[[${tp.date.now("YYYY-[W]ww", new Date(targetDate))}]]"
month: "[[${tp.date.now("YYYY-MM", new Date(targetDate))}]]"
---

# cockpit | ${tp.date.now("dddd, YYYY-MM-DD", new Date(targetDate))}

> [!quote] 今日引言
> > 思考的价值在于连接，而不在于记忆。

---

### § 1. 晨间校准 (Morning Briefing)
*今日航向：明确目标，轻装上阵。*

**🎯 本日三大核心目标 (Top 3 Priorities):**
- [ ] 
- [ ] 
- [ ] 

**🗓️ 今日关键日程 (Scheduled Events):**

**📋 今日待办任务 (Today's Tasks):**
${taskFormat}

---

### § 2. 实时战术记录 (Workbench Log)
*捕捉一切：想法、数据、对话。在这里进行"链接式思考"。*

- **09:00** 
- 

---

### § 3. 信息处理与原子化 (Info Triage)
*清空\`INBOX\`，将外部信息转化为内部洞见。*

**📥 INBOX 清理:**
- [ ] 今日是否已处理 \`00 - INBOX\` 中的所有暂存信息？

**⚛️ 今日生成的新思想原子 (New Atoms Created):**
*处理信息后，在这里链接今日创建或深度加工的\`ATOMS\`笔记*
- **概念**: 
- **模型**: 
- **情报**: 

---

### § 4. 晚间复盘与洞察合成 (Evening Review & Synthesis)

> [!success] **本日成果 (Key Accomplishments):**
> - 

<br>

> [!multi-line] **🔥 洞察发现引擎 (Connection Discovery Engine) 🔥**
> 
> **这是今日最有价值的5分钟。打开右侧面板的"反向链接"。**
> 
> 1. **检查"链接提及"**: 回顾我今天主动建立了哪些有价值的连接？
>    - 
> 
> 2. **审视"未链接提及"**: Obsidian帮我发现了哪些被我忽略的潜在连接？（点击"链接"按钮建立关系）
>    - 
> 
> **💡 基于以上发现，我今天最大的洞察或"啊哈"时刻是什么？**
> *这个洞察是关于一个[[新产品机会]]？还是关于[[某个项目风险]]？或是对[[某个技术概念]]的更深理解？*
> - 
> 

<br>

> [!question] **遗留问题与明日思考 (Open Loops & Next Day's Questions):**
> *今天有什么问题没有解决？我的思考卡在了哪里？这个问题值得创建一个[[MOC]]来持续孵化吗？*
> -
`;
            await tp.file.create_new(dailyTemplate, futureNotePath);
        } else {
            // 更新现有每日笔记
            const existingContent = await app.vault.read(futureFile);
            const taskSection = existingContent.match(/📋 今日待办任务 \(Today's Tasks\):\*[\s\S]*?(?=\n---|\n###)/);
            if (taskSection) {
                const updatedContent = existingContent.replace(
                    taskSection[0],
                    taskSection[0] + `\n${taskFormat}`
                );
                await app.vault.modify(futureFile, updatedContent);
            }
        }
    }
}

new Notice(`日程已添加：${cleanDescription}`);
%>