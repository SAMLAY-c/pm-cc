<%*
// èŽ·å–ç”¨æˆ·è¾“å…¥çš„æ—¥ç¨‹ä¿¡æ¯
const scheduleInput = await tp.system.prompt("è¯·è¾“å…¥æ—¥ç¨‹ä¿¡æ¯ï¼ˆåŒ…å«æ—¶é—´å’Œä»»åŠ¡æè¿°ï¼‰ï¼š");

if (!scheduleInput) {
    new Notice("è¯·è¾“å…¥æ—¥ç¨‹ä¿¡æ¯");
    return;
}

// èŽ·å–å½“å‰æ—¥æœŸ
const today = tp.date.now("YYYY-MM-DD");
const tomorrow = tp.date.now("YYYY-MM-DD", 1);
const now = new Date();

// è¯†åˆ«æ—¥æœŸå’Œæ—¶é—´çš„å‡½æ•°
function parseDateTime(input) {
    const dateMatch = input.match(/(\d{4}-\d{2}-\d{2})/);
    const timeMatch = input.match(/(\d{1,2}):(\d{2})/);
    
    let targetDate = today;
    let timeStr = "";
    
    // è¯†åˆ«æ—¥æœŸå…³é”®è¯
    if (input.includes("æ˜Žå¤©") || input.includes("tomorrow")) {
        targetDate = tomorrow;
    } else if (input.includes("åŽå¤©")) {
        targetDate = tp.date.now("YYYY-MM-DD", 2);
    } else if (input.includes("ä¸‹å‘¨")) {
        targetDate = tp.date.now("YYYY-MM-DD", 7);
    } else if (dateMatch) {
        targetDate = dateMatch[1];
    }
    
    // è¯†åˆ«æ—¶é—´
    if (timeMatch) {
        timeStr = ` ${timeMatch[1]}:${timeMatch[2]}`;
    }
    
    return { targetDate, timeStr };
}

// åˆ¤æ–­ä»»åŠ¡ç±»åž‹
function getTaskType(input) {
    if (input.includes("ä¼šè®®") || input.includes("meeting") || input.includes("è®¨è®º") || input.includes("review")) {
        return "meeting";
    } else if (input.includes("å®Œæˆ") || input.includes("åš") || input.includes("å†™") || input.includes("å¼€å‘")) {
        return "task";
    } else {
        return "reminder";
    }
}

// è§£æžæ—¥ç¨‹ä¿¡æ¯
const { targetDate, timeStr } = parseDateTime(scheduleInput);
const taskType = getTaskType(scheduleInput);

// æ¸…ç†è¾“å…¥æè¿°ï¼ˆç§»é™¤æ—¶é—´å…³é”®è¯ï¼‰
let cleanDescription = scheduleInput
    .replace(/(\d{4}-\d{2}-\d{2})/, "")
    .replace(/(\d{1,2}):(\d{2})/, "")
    .replace(/ä»Šå¤©|æ˜Žå¤©|åŽå¤©|ä¸‹å‘¨|today|tomorrow|next week/gi, "")
    .replace(/ä¼šè®®|meeting|è®¨è®º|review/gi, "")
    .trim();

// æ ¹æ®ä»»åŠ¡ç±»åž‹å¤„ç†
if (taskType === "meeting") {
    // åˆ›å»ºä¼šè®®ç¬”è®°
    const meetingTitle = cleanDescription || "ä¼šè®®";
    const meetingFileName = `${targetDate} - ${meetingTitle}`;
    const meetingPath = `40 - OPERATIONS/Meetings/${meetingFileName}.md`;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const meetingFile = app.vault.getAbstractFileByPath(meetingPath);
    if (!meetingFile) {
        // åˆ›å»ºä¼šè®®ç¬”è®°
        const meetingContent = `---
tags: meeting
date: ${targetDate}
time: "${timeStr.trim()}"
participants: 
---

# ${meetingTitle}

## ä¼šè®®ç›®æ ‡

## è®¨è®ºè¦ç‚¹

## å…³é”®å†³ç­–

## è¡ŒåŠ¨é¡¹
- [ ] 
- [ ] 

## ç›¸å…³é“¾æŽ¥
- [[${today}]]
`;
        await tp.file.create_new(meetingContent, meetingPath);
        new Notice(`å·²åˆ›å»ºä¼šè®®ç¬”è®°ï¼š${meetingTitle}`);
    }
    
    // å¦‚æžœæ˜¯ä»Šå¤©çš„ä¼šè®®ï¼Œæ·»åŠ åˆ°å½“å‰ç¬”è®°
    if (targetDate === today) {
        const meetingLink = `[[${meetingFileName}]]${timeStr}`;
        const currentContent = tp.file.content;
        
        // æŸ¥æ‰¾ä»Šæ—¥å…³é”®æ—¥ç¨‹éƒ¨åˆ†å¹¶æ·»åŠ é“¾æŽ¥
        const scheduleSection = currentContent.match(/ðŸ—“ï¸ ä»Šæ—¥å…³é”®æ—¥ç¨‹ \(Scheduled Events\):\*[\s\S]*?(?=\n---|\n###)/);
        if (scheduleSection) {
            const updatedContent = currentContent.replace(
                scheduleSection[0],
                scheduleSection[0] + `\n- ${meetingLink}`
            );
            await tp.file.update(updatedContent);
        }
    }
} else {
    // åˆ›å»ºä»»åŠ¡
    const priority = scheduleInput.includes("ç´§æ€¥") || scheduleInput.includes("é‡è¦") ? "high" : 
                   scheduleInput.includes("ä¸­ç­‰") ? "medium" : "low";
    
    const taskFormat = `- [ ] ${cleanDescription}${timeStr} ðŸ“… ${targetDate} priority:: ${priority}`;
    
    // å¦‚æžœæ˜¯ä»Šå¤©çš„ä»»åŠ¡ï¼Œæ·»åŠ åˆ°å½“å‰ç¬”è®°
    if (targetDate === today) {
        const currentContent = tp.file.content;
        
        // æŸ¥æ‰¾ä»Šæ—¥å¾…åŠžä»»åŠ¡éƒ¨åˆ†å¹¶æ·»åŠ ä»»åŠ¡
        const taskSection = currentContent.match(/ðŸ“‹ ä»Šæ—¥å¾…åŠžä»»åŠ¡ \(Today's Tasks\):\*[\s\S]*?(?=\n---|\n###)/);
        if (taskSection) {
            const updatedContent = currentContent.replace(
                taskSection[0],
                taskSection[0] + `\n${taskFormat}`
            );
            await tp.file.update(updatedContent);
        }
    } else {
        // åˆ›å»ºæˆ–æ›´æ–°æœªæ¥æ—¥æœŸçš„æ¯æ—¥ç¬”è®°
        const futureNotePath = `10 - COCKPIT/Daily/${targetDate}.md`;
        const futureFile = app.vault.getAbstractFileByPath(futureNotePath);
        
        if (!futureFile) {
            // åˆ›å»ºæ–°çš„æ¯æ—¥ç¬”è®°
            const dailyTemplate = `---
tags: daily
date: ${targetDate}
week: "[[${tp.date.now("YYYY-[W]ww", new Date(targetDate))}]]"
month: "[[${tp.date.now("YYYY-MM", new Date(targetDate))}]]"
---

# cockpit | ${tp.date.now("dddd, YYYY-MM-DD", new Date(targetDate))}

> [!quote] ä»Šæ—¥å¼•è¨€
> > æ€è€ƒçš„ä»·å€¼åœ¨äºŽè¿žæŽ¥ï¼Œè€Œä¸åœ¨äºŽè®°å¿†ã€‚

---

### Â§ 1. æ™¨é—´æ ¡å‡† (Morning Briefing)
*ä»Šæ—¥èˆªå‘ï¼šæ˜Žç¡®ç›®æ ‡ï¼Œè½»è£…ä¸Šé˜µã€‚*

**ðŸŽ¯ æœ¬æ—¥ä¸‰å¤§æ ¸å¿ƒç›®æ ‡ (Top 3 Priorities):**
- [ ] 
- [ ] 
- [ ] 

**ðŸ—“ï¸ ä»Šæ—¥å…³é”®æ—¥ç¨‹ (Scheduled Events):**

**ðŸ“‹ ä»Šæ—¥å¾…åŠžä»»åŠ¡ (Today's Tasks):**
${taskFormat}

---

### Â§ 2. å®žæ—¶æˆ˜æœ¯è®°å½• (Workbench Log)
*æ•æ‰ä¸€åˆ‡ï¼šæƒ³æ³•ã€æ•°æ®ã€å¯¹è¯ã€‚åœ¨è¿™é‡Œè¿›è¡Œ"é“¾æŽ¥å¼æ€è€ƒ"ã€‚*

- **09:00** 
- 

---

### Â§ 3. ä¿¡æ¯å¤„ç†ä¸ŽåŽŸå­åŒ– (Info Triage)
*æ¸…ç©º\`INBOX\`ï¼Œå°†å¤–éƒ¨ä¿¡æ¯è½¬åŒ–ä¸ºå†…éƒ¨æ´žè§ã€‚*

**ðŸ“¥ INBOX æ¸…ç†:**
- [ ] ä»Šæ—¥æ˜¯å¦å·²å¤„ç† \`00 - INBOX\` ä¸­çš„æ‰€æœ‰æš‚å­˜ä¿¡æ¯ï¼Ÿ

**âš›ï¸ ä»Šæ—¥ç”Ÿæˆçš„æ–°æ€æƒ³åŽŸå­ (New Atoms Created):**
*å¤„ç†ä¿¡æ¯åŽï¼Œåœ¨è¿™é‡Œé“¾æŽ¥ä»Šæ—¥åˆ›å»ºæˆ–æ·±åº¦åŠ å·¥çš„\`ATOMS\`ç¬”è®°*
- **æ¦‚å¿µ**: 
- **æ¨¡åž‹**: 
- **æƒ…æŠ¥**: 

---

### Â§ 4. æ™šé—´å¤ç›˜ä¸Žæ´žå¯Ÿåˆæˆ (Evening Review & Synthesis)

> [!success] **æœ¬æ—¥æˆæžœ (Key Accomplishments):**
> - 

<br>

> [!multi-line] **ðŸ”¥ æ´žå¯Ÿå‘çŽ°å¼•æ“Ž (Connection Discovery Engine) ðŸ”¥**
> 
> **è¿™æ˜¯ä»Šæ—¥æœ€æœ‰ä»·å€¼çš„5åˆ†é’Ÿã€‚æ‰“å¼€å³ä¾§é¢æ¿çš„"åå‘é“¾æŽ¥"ã€‚**
> 
> 1. **æ£€æŸ¥"é“¾æŽ¥æåŠ"**: å›žé¡¾æˆ‘ä»Šå¤©ä¸»åŠ¨å»ºç«‹äº†å“ªäº›æœ‰ä»·å€¼çš„è¿žæŽ¥ï¼Ÿ
>    - 
> 
> 2. **å®¡è§†"æœªé“¾æŽ¥æåŠ"**: Obsidianå¸®æˆ‘å‘çŽ°äº†å“ªäº›è¢«æˆ‘å¿½ç•¥çš„æ½œåœ¨è¿žæŽ¥ï¼Ÿï¼ˆç‚¹å‡»"é“¾æŽ¥"æŒ‰é’®å»ºç«‹å…³ç³»ï¼‰
>    - 
> 
> **ðŸ’¡ åŸºäºŽä»¥ä¸Šå‘çŽ°ï¼Œæˆ‘ä»Šå¤©æœ€å¤§çš„æ´žå¯Ÿæˆ–"å•Šå“ˆ"æ—¶åˆ»æ˜¯ä»€ä¹ˆï¼Ÿ**
> *è¿™ä¸ªæ´žå¯Ÿæ˜¯å…³äºŽä¸€ä¸ª[[æ–°äº§å“æœºä¼š]]ï¼Ÿè¿˜æ˜¯å…³äºŽ[[æŸä¸ªé¡¹ç›®é£Žé™©]]ï¼Ÿæˆ–æ˜¯å¯¹[[æŸä¸ªæŠ€æœ¯æ¦‚å¿µ]]çš„æ›´æ·±ç†è§£ï¼Ÿ*
> - 
> 

<br>

> [!question] **é—ç•™é—®é¢˜ä¸Žæ˜Žæ—¥æ€è€ƒ (Open Loops & Next Day's Questions):**
> *ä»Šå¤©æœ‰ä»€ä¹ˆé—®é¢˜æ²¡æœ‰è§£å†³ï¼Ÿæˆ‘çš„æ€è€ƒå¡åœ¨äº†å“ªé‡Œï¼Ÿè¿™ä¸ªé—®é¢˜å€¼å¾—åˆ›å»ºä¸€ä¸ª[[MOC]]æ¥æŒç»­å­µåŒ–å—ï¼Ÿ*
> -
`;
            await tp.file.create_new(dailyTemplate, futureNotePath);
        } else {
            // æ›´æ–°çŽ°æœ‰æ¯æ—¥ç¬”è®°
            const existingContent = await app.vault.read(futureFile);
            const taskSection = existingContent.match(/ðŸ“‹ ä»Šæ—¥å¾…åŠžä»»åŠ¡ \(Today's Tasks\):\*[\s\S]*?(?=\n---|\n###)/);
            if (taskSection) {
                const updatedContent = existingContent.replace(
                    taskSection[0],
                    taskSection[0] + `\n${taskFormat}`
                );
                await app.vault.modify(futureFile, updatedContent);
            }
        }
    }
}

new Notice(`æ—¥ç¨‹å·²æ·»åŠ ï¼š${cleanDescription}`);
%>